# Invite Management API
# Alle Endpoints für Einladungs-Verwaltung

paths:
  /api/invites/validate/{token}:
    get:
      tags:
        - Invites
      summary: Token validieren und Welt-Informationen abrufen
      description: |
        Validiert einen Invite-Token und gibt die Welt-Informationen zurück.
        Prüft auch E-Mail-Berechtigung basierend auf Login-Status.
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Der Invite-Token
        - name: Authorization
          in: header
          required: false
          schema:
            type: string
          description: Optional - Bearer Token für angemeldete User
      responses:
        '200':
          description: Token erfolgreich validiert
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      world:
                        $ref: '#/components/schemas/WorldInfo'
                      invite:
                        $ref: '#/components/schemas/InviteInfo'
                      userStatus:
                        $ref: '#/components/schemas/UserStatus'
        '400':
          description: Token fehlt
        '404':
          description: Token ungültig oder abgelaufen

  /api/invites/accept/{token}:
    post:
      tags:
        - Invites
      summary: Einladung akzeptieren
      description: Akzeptiert eine Einladung und fügt den User zur Welt hinzu
      security:
        - bearerAuth: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Der Invite-Token
      responses:
        '200':
          description: Einladung erfolgreich akzeptiert
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                      world:
                        $ref: '#/components/schemas/WorldInfo'
                      invitedBy:
                        type: string
                      acceptedAt:
                        type: string
                        format: date-time
        '403':
          description: E-Mail-Mismatch oder fehlende Berechtigung
        '404':
          description: Ungültiger Token
        '409':
          description: Invite bereits akzeptiert
        '410':
          description: Token abgelaufen

  /api/invites/decline/{token}:
    post:
      tags:
        - Invites
      summary: Einladung ablehnen
      description: Lehnt eine Einladung ab (löscht sie)
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Der Invite-Token
      responses:
        '200':
          description: Einladung erfolgreich abgelehnt
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      world:
                        $ref: '#/components/schemas/WorldInfo'
                      invitedBy:
                        type: string
        '404':
          description: Ungültiger Token
        '409':
          description: Invite bereits akzeptiert
        '410':
          description: Token abgelaufen

  /api/invites:
    post:
      tags:
        - Invites
      summary: Einladungen erstellen
      description: Erstellt neue Einladungen für eine Welt (authentifiziert)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                worldId:
                  type: integer
                  description: ID der Welt
                email:
                  type: string
                  format: email
                  description: Einzelne E-Mail-Adresse
                emails:
                  type: array
                  items:
                    type: string
                    format: email
                  description: Array von E-Mail-Adressen
              required:
                - worldId
      responses:
        '200':
          description: Einladungen erfolgreich erstellt
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      invites:
                        type: array
                        items:
                          $ref: '#/components/schemas/CreatedInvite'
        '400':
          description: Ungültige Eingabe oder alle E-Mails haben bereits Einladungen
        '403':
          description: Keine Berechtigung (invite.create Permission erforderlich)

  /api/invites/public:
    post:
      tags:
        - Invites
      summary: Öffentliche Einladungen erstellen
      description: Erstellt öffentliche Einladungen (keine Authentifizierung erforderlich)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                worldId:
                  type: integer
                  description: ID der Welt
                email:
                  type: string
                  format: email
                  description: Einzelne E-Mail-Adresse
                emails:
                  type: array
                  items:
                    type: string
                    format: email
                  description: Array von E-Mail-Adressen
              required:
                - worldId
      responses:
        '200':
          description: Öffentliche Einladungen erfolgreich erstellt
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      invites:
                        type: array
                        items:
                          $ref: '#/components/schemas/CreatedInvite'
        '403':
          description: Welt ist nicht für öffentliche Einladungen geöffnet
        '404':
          description: Welt nicht gefunden

  /api/invites/world/{worldId}:
    get:
      tags:
        - Invites
      summary: Einladungen einer Welt anzeigen
      description: Gibt alle Einladungen einer Welt zurück
      parameters:
        - name: worldId
          in: path
          required: true
          schema:
            type: integer
          description: ID der Welt
      responses:
        '200':
          description: Einladungen erfolgreich abgerufen
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/InviteDetails'
        '400':
          description: Ungültige Welt-ID

  /api/invites/{id}:
    delete:
      tags:
        - Invites
      summary: Einladung löschen
      description: Löscht eine Einladung (authentifiziert)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID der Einladung
      responses:
        '200':
          description: Einladung erfolgreich gelöscht
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '403':
          description: Keine Berechtigung (invite.delete Permission erforderlich)
        '404':
          description: Einladung nicht gefunden

components:
  schemas:
    WorldInfo:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        status:
          type: string
          enum: [upcoming, open, running, closed, archived]
        createdAt:
          type: string
          format: date-time
        startsAt:
          type: string
          format: date-time
        endsAt:
          type: string
          format: date-time

    InviteInfo:
      type: object
      properties:
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
        acceptedAt:
          type: string
          format: date-time
          nullable: true
        invitedBy:
          type: object
          nullable: true
          properties:
            username:
              type: string

    UserStatus:
      type: object
      properties:
        status:
          type: string
          enum: [not_logged_in, user_exists_not_logged_in, correct_email, wrong_email]
        requiresAction:
          type: string
          enum: [register, login, join_world, logout_and_register]
        currentUser:
          type: object
          nullable: true
          properties:
            username:
              type: string
            email:
              type: string
              format: email

    CreatedInvite:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        token:
          type: string
        worldId:
          type: integer
        expiresAt:
          type: string
          format: date-time

    InviteDetails:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        token:
          type: string
        createdAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
        acceptedAt:
          type: string
          format: date-time
          nullable: true
        invitedBy:
          type: object
          nullable: true
          properties:
            username:
              type: string

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT